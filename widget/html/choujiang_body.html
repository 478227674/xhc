<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <meta name="format-detection" content="telephone=no"/>
    <title></title>
    <link rel="stylesheet" type="text/css" href="../css/commonWindow.css">
    <link rel="stylesheet" type="text/css" href="../css/api.css"/>
    <link rel="stylesheet" type="text/css" href="../css/type.css"/>
    <style>
        body{
            overflow: hidden;
        }
        body,ul,ol,li,p,h1,h2,h3,h4,h5,h6,form,fieldset,table,td,img,div{margin:0;padding:0;border:0;}
        /*body{color:#333; font-size:12px;font-family:"Microsoft YaHei"}*/
        ul,ol{list-style-type:none;}
        select,input,img,select{vertical-align:middle;}
        input{ font-size:12px;}
        .clear{clear:both;}

        /* 大转盘样式 */
        .banner{display:block;width:80%;position: absolute;
            bottom: 20px;left: 11.5%;
        }
        .banner .turnplate{display:block;width:100%;position:relative;}
        .banner .turnplate canvas.item{width:100%;}
        .banner .turnplate img.pointer{position:absolute;width:31.5%;left:34.1%;top:31%;}
        #sbtn{ position: absolute;top: 85%;text-align: center;width: 100%; }
        #sbtn img{ width: 24%;margin: 0 20px; }

    </style>
</head>
<body>
    <img src="../icon/game-bg.jpg" alt="" style="position: absolute;width: 100%;height: 100%;">
    <div class="content">
        <img class="iconlist" src=""  style="display:none;" />
        <img class="iconlist" src=""  style="display:none;" />
        <img class="iconlist" src="" style="display:none;" />
        <img class="iconlist" src=""  style="display:none;" />
        <img class="iconlist" src=""  style="display:none;" />
        <img class="iconlist" src=""  style="display:none;" />
        <div class="banner">
            <div class="turnplate" style="background-image:url(../icon/turnplate-bg.png);background-size:100% 100%;">
                <canvas class="item" id="wheelcanvas" width="422px" height="422px"></canvas>
                <img class="pointer" src="../icon/turnplate-pointer.png"/>
            </div>
        </div>
    </div>

</body>


<script type="text/javascript" src="../script/zepto.js"></script>
<script type="text/javascript" src="../script/awardRotate.js"></script>
<script type="text/javascript" src="../script/scroll.js"></script>
<script type="text/javascript" src="../script/api.js"></script>
<script type="text/javascript" src="../script/user.js"></script>
<script type="text/javascript" src="../script/apiCloud.js"></script>
<script type="text/javascript" src="../script/public.js"></script>
<script type="text/javascript" src="../script/echo.min.js"></script>
<script type="text/javascript">
    var ret = [
        {"pageNum":1,"pageSize":10,"imageUrl":"https://img13.360buyimg.com/mobilecms/s250x250_jfs/t1/48005/14/8359/158953/5d5bc3c8E562fdba6/0c31315a2d255956.jpg","createTime":"2019-09-16T09:30:08.000+0000","updateTime":"2019-09-18T01:42:56.000+0000","cTimeStr":"2019-09-16 17:30:08","uTimeStr":"2019-09-18 09:42:56","prizeId":1,"prizeContent":"太奇币20个","prizeNum":11,"prizeUnit":"个","imageId":11,"isDelete":0},
        {"pageNum":1,"pageSize":10,"imageUrl":"https://img13.360buyimg.com/mobilecms/s250x250_jfs/t1/48005/14/8359/158953/5d5bc3c8E562fdba6/0c31315a2d255956.jpg","createTime":"2019-09-16T09:30:18.000+0000","updateTime":"2019-09-19T08:38:29.000+0000","cTimeStr":"2019-09-16 17:30:18","uTimeStr":"2019-09-19 16:38:29","prizeId":2,"prizeContent":"太奇币50个","prizeNum":50,"prizeUnit":"个","imageId":2,"isDelete":0},
        {"pageNum":1,"pageSize":10,"imageUrl":"https://img13.360buyimg.com/mobilecms/s250x250_jfs/t1/48005/14/8359/158953/5d5bc3c8E562fdba6/0c31315a2d255956.jpg","createTime":"2019-09-16T09:30:24.000+0000","updateTime":"2019-09-19T08:38:36.000+0000","cTimeStr":"2019-09-16 17:30:24","uTimeStr":"2019-09-19 16:38:36","prizeId":3,"prizeContent":"太奇币100个","prizeNum":100,"prizeUnit":"个","imageId":3,"isDelete":0},
        {"pageNum":1,"pageSize":10,"imageUrl":"https://img13.360buyimg.com/mobilecms/s250x250_jfs/t1/48005/14/8359/158953/5d5bc3c8E562fdba6/0c31315a2d255956.jpg","createTime":"2019-09-16T09:30:31.000+0000","updateTime":"2019-09-19T08:38:43.000+0000","cTimeStr":"2019-09-16 17:30:31","uTimeStr":"2019-09-19 16:38:43","prizeId":4,"prizeContent":"话费10元","prizeNum":1,"prizeUnit":"元","imageId":4,"isDelete":0},
        {"pageNum":1,"pageSize":10,"imageUrl":"https://img13.360buyimg.com/mobilecms/s250x250_jfs/t1/48005/14/8359/158953/5d5bc3c8E562fdba6/0c31315a2d255956.jpg","createTime":"2019-09-16T09:30:35.000+0000","updateTime":"2019-09-19T08:38:51.000+0000","cTimeStr":"2019-09-16 17:30:35","uTimeStr":"2019-09-19 16:38:51","prizeId":5,"prizeContent":"话费20元","prizeNum":2,"prizeUnit":"元","imageId":264,"isDelete":0},
        {"pageNum":1,"pageSize":10,"imageUrl":"https://img13.360buyimg.com/mobilecms/s250x250_jfs/t1/48005/14/8359/158953/5d5bc3c8E562fdba6/0c31315a2d255956.jpg","createTime":"2019-09-16T09:30:38.000+0000","updateTime":"2019-09-19T08:38:56.000+0000","cTimeStr":"2019-09-16 17:30:38","uTimeStr":"2019-09-19 16:38:56","prizeId":6,"prizeContent":"话费30元","prizeNum":5,"prizeUnit":"元","imageId":6,"isDelete":0}
        ]
    var turnplate={
        restaraunts:[],				//大转盘奖品名称
        colors:[],					//大转盘奖品区块对应背景颜色
        outsideRadius:192,			//大转盘外圆的半径
        textRadius:155,				//大转盘奖品位置距离圆心的距离
        insideRadius:68,			//大转盘内圆的半径
        startAngle:0,				//开始角度
        bRotate:false				//false:停止;ture:旋转
    };

    $(document).ready(function(){
        //动态添加大转盘的奖品与奖品区域背景颜色
        for(var i=0;i<ret.length;i++){
            turnplate.restaraunts.push(ret[i].prizeContent)
            $($('.iconlist')[i]).attr('id','a'+ret[i].prizeId)
            $($('.iconlist')[i]).attr('src',ret[i].imageUrl)
        }
//        turnplate.restaraunts = ["20积分", "足疗机", "20积分", "保温杯", "20积分", "手持式电熨斗"];
        turnplate.colors = ["#FFF4D6", "#FFFFFF", "#FFF4D6", "#FFFFFF","#FFF4D6", "#FFFFFF"];
        var rotateTimeOut = function (){
            $('#wheelcanvas').rotate({
                angle:0,
                animateTo:2160,
                duration:8000,
                callback:function (){
                    alert('网络超时，请检查您的网络设置！');
                }
            });
        };

        //旋转转盘 item:奖品位置; txt：提示语;
        var rotateFn = function (item, txt){
            var angles = item * (360 / turnplate.restaraunts.length) - (360 / (turnplate.restaraunts.length*2));
            if(angles<270){
                angles = 270 - angles;
            }else{
                angles = 360 - angles + 270;
            }
            $('#wheelcanvas').stopRotate();
            $('#wheelcanvas').rotate({
                angle:0,
                animateTo:angles+1800,
                duration:8000,
                callback:function (){
                    //中奖提示
                    api.execScript({
                        name:'root',
                        frameName:'home',
                        script:'closeChoujiang()'
                    })
                    turnplate.bRotate = !turnplate.bRotate;
                }
            });
        };

        $('.pointer').click(function (){
            if(turnplate.bRotate)return;
            turnplate.bRotate = !turnplate.bRotate;
            //获取随机数(奖品个数范围内)
            var item = rnd(1,turnplate.restaraunts.length);
            //奖品数量等于10,指针落在对应奖品区域的中心角度[252, 216, 180, 144, 108, 72, 36, 360, 324, 288]
            rotateFn(item, turnplate.restaraunts[item-1]);
        });
    });

    function rnd(n, m){
        n=1;//最小随机数
        m=60;//最大随机数（概率范围最大值）
        //最大数数不超过最大随机数
        var ransluck = [40,54,56,58,60,61];//概率为比自己小的第一个数之间的差
        var randoms = Math.floor(Math.random()*(m-n+1)+n);
        if(randoms<=ransluck[0])
        {
            var random = 1;
        }
        else if(randoms<=ransluck[1])
        {
            var random = 2;
        }
        else if(randoms<=ransluck[2])
        {
            var random = 3;
        }
        else if(randoms<=ransluck[3])
        {
            var random = 4;
        }
        else if(randoms<=ransluck[4])
        {
            var random = 5;
        }
        else if(randoms<=ransluck[5])
        {
            var random = 6;
        }
        //alert(randoms);
        //alert(random);
        return random;

    }


    //页面所有元素加载完毕后执行drawRouletteWheel()方法对转盘进行渲染
    window.onload=function(){
        drawRouletteWheel();
    };
    function drawRouletteWheel() {
        var canvas = document.getElementById("wheelcanvas");
        if (canvas.getContext) {
            //根据奖品个数计算圆周角度
            var arc = Math.PI / (turnplate.restaraunts.length/2);
            var ctx = canvas.getContext("2d");
            //在给定矩形内清空一个矩形
            ctx.clearRect(0,0,422,422);
            //strokeStyle 属性设置或返回用于笔触的颜色、渐变或模式
            ctx.strokeStyle = "#FFBE04";
            //font 属性设置或返回画布上文本内容的当前字体属性
            ctx.font = '16px Microsoft YaHei';
            for(var i = 0; i < turnplate.restaraunts.length; i++) {
                var angle = turnplate.startAngle + i * arc;
                ctx.fillStyle = turnplate.colors[i];
                ctx.beginPath();
                //arc(x,y,r,起始角,结束角,绘制方向) 方法创建弧/曲线（用于创建圆或部分圆）
                ctx.arc(211, 211, turnplate.outsideRadius, angle, angle + arc, false);
                ctx.arc(211, 211, turnplate.insideRadius, angle + arc, angle, true);
                ctx.stroke();
                ctx.fill();
                //锁画布(为了保存之前的画布状态)
                ctx.save();

                //----绘制奖品开始----
                ctx.fillStyle = "#E5302F";
                var text = turnplate.restaraunts[i];
                var line_height = 17;
                //translate方法重新映射画布上的 (0,0) 位置
                ctx.translate(211 + Math.cos(angle + arc / 2) * turnplate.textRadius, 211 + Math.sin(angle + arc / 2) * turnplate.textRadius);

                //rotate方法旋转当前的绘图
                ctx.rotate(angle + arc / 2 + Math.PI / 2);
                ctx.fillText(text, -ctx.measureText(text).width / 2, 0);
//                //添加对应图标


                var r = ret.filter(function (item) {
                    return item.prizeContent == text;
                });
                var img = document.getElementById("a"+r[0].prizeId);
                img.onload=function(){
                    ctx.drawImage(img,-15,10);
                };
                ctx.drawImage(img,-15,10,30,30);
                //把当前画布返回（调整）到上一个save()状态之前
                ctx.restore();
                //----绘制奖品结束----
            }
        }
    }

</script>
</html>
